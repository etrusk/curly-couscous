---
name: tdd
description: Execute full TDD workflow for a feature or bugfix. Orchestrates all phases automatically.
---

# TDD Workflow Orchestrator

You are a LIGHTWEIGHT ROUTER orchestrating Test-Driven Development. Execute the workflow COMPLETELY AUTONOMOUSLY—NEVER ask permission between phases.

**Your job:**

1. Read `.tdd/session.md` for current state
2. Spawn appropriate agent via Task tool
3. Update `.tdd/session.md` "Current Phase" field when transitioning phases
4. Continue to next phase IMMEDIATELY

**Note**: Agents update session.md with their phase results and findings. Orchestrator updates the "Current Phase" field when routing to next phase.

**CRITICAL**: Use Task tool to spawn agents. NEVER ask "should I proceed?" or "ready to continue?"—execute the next phase automatically.

Do NOT read implementation files directly.

---

## Request Clarification (MANDATORY for new workflows)

**For NEW workflows only**, analyze and clarify the request BEFORE starting INIT:

**Analyze:**

- What/why/where/scope/complexity
- Missing: acceptance criteria, constraints, edge cases
- Alternatives: simpler approaches, phased implementation, architectural concerns
- Examples: "Add dark mode" → too broad, suggest phase 1 (toggle) vs phase 2 (styling). "Fix bug" → which bug, reproduction steps?

**Present to human:**

```
Understanding: [what needs to be done, scope, complexity]
Questions: [ambiguities requiring answers]
Alternatives: [if multiple valid approaches exist]
Concerns: [architectural/scope issues if any]
```

**Wait for confirmation.** After receiving confirmation, proceed to INIT phase to create `.tdd/session.md` with:

```markdown
## Confirmed Scope

[2-4 sentence summary]

## Acceptance Criteria

- [criterion 1]
- [criterion 2]
```

**Skip clarification when:**
- Resuming existing session (session.md exists)
- Human provided detailed spec with clear acceptance criteria
- Task is trivial: single-line bug fix, typo correction, adding missing import, or formatting-only change

If skipping, document reason in session.md and proceed to INIT.

---

## Browser Automation (MANDATORY for UI Tasks)

**CRITICAL**: For ANY task involving UI implementation or browser-based debugging, agents MUST use **Claude in Chrome** integration.

**NON-NEGOTIABLE REQUIREMENT**: Skipping browser verification for UI tasks is considered incomplete work and will result in implementation failure. Agents cannot claim completion without browser verification.

**Agents MUST use browser automation for:**

- ANY implementation/modification of visual components (buttons, forms, game UI)
- ANY debugging of rendering issues, CSS problems, or interaction bugs
- ALL browser console error verification and DOM state inspection
- Recording workflows as GIFs for documentation when:
  * Implementing multi-step user workflows (e.g., form submission flow)
  * Demonstrating complex interactions (e.g., drag-and-drop, animations)
  * Documenting a bug fix that required browser debugging
  * Skip GIF for simple single-interaction changes or non-visual changes

**Automated browser verification (agents MUST perform):**

1. **During IMPLEMENT (coder agent)**: MUST ALWAYS perform after writing ANY UI code:
   - **Verify dev server status**: Check if already running with `curl -s http://localhost:5173 > /dev/null && echo "Running" || echo "Not running"`
   - **Start dev server** ONLY if not running:
     * Use Bash tool with `run_in_background=true` parameter
     * Command: `npm run dev`
     * Wait 3-5 seconds for server startup before attempting browser navigation
     * If navigation fails, check dev server output for port conflicts or startup errors
   - **Navigate to relevant page**:
     * Check `.tdd/plan.md` for mentioned routes/pages
     * If implementing new component, navigate to page that uses it
     * If modifying existing page, navigate to that page's route
     * Default fallback: `http://localhost:5173/` (root page)
     * Document the URL navigated to in Browser Verification section
   - **Verify component renders without console errors**: Use browser console inspection
   - **Test interactions relevant to changes**:
     * If added button: Click it and verify expected action occurs
     * If added form field: Enter text and verify it appears/validates correctly
     * If added toggle/checkbox: Click it and verify state changes
     * Check browser console shows zero errors after interactions
     * Document which interactions were tested in Browser Verification section
   - **Document findings** in `.tdd/session.md` under "Browser Verification"
   - **NEVER skip this step** - failure to verify is considered incomplete implementation

2. **During FIX (coder agent)**: MUST be performed for ALL UI-related bugs:
   - Read browser console for errors
   - Inspect DOM state and element properties
   - Test problematic interactions
   - Verify fixes resolve console errors
   - **NEVER attempt UI bug fixes without browser verification**

3. **During troubleshooting**: MUST use live debugging with browser context for ANY UI-related issues

**Browser availability check (agents MUST perform):**

When browser verification is required, agents MUST:
1. **Actually attempt** to use browser tools (start with `tabs_context_mcp`)
2. **If browser extension not connected**: Report as BLOCKER to orchestrator with actual error message
3. **NEVER assume** browser is unavailable without attempting the tools
4. **Orchestrator escalates** browser connection failures to human for manual verification or extension setup

**Human verification (HUMAN_VERIFY phase):**

- Orchestrator suggests specific manual tests for the user
- User verifies end-to-end functionality, visual appearance, edge cases
- User confirms implementation meets requirements

**Key capabilities:**

- Navigate pages, click elements, fill forms
- Read console errors and network requests
- Inspect DOM state and accessibility tree
- Record sessions as GIFs

**Safety note:** Browser automation requires explicit user permission for sensitive actions (form submissions, downloads, account operations). Agents should request approval when needed.

**Availability:** Requires Claude in Chrome extension (beta, Google Chrome only).

---

## Pre-Workflow Validation

Before starting ANY new workflow:

1. **Check existing session**: `cat .tdd/session.md 2>/dev/null || echo "NO_SESSION"`
   - Session exists with incomplete phase → Resume from current phase
   - No session → Create new session

2. **Check project status**: `cat .docs/current-task.md 2>/dev/null || echo "NO_CURRENT_TASK"`
   - Read "Current Focus" for context from prior sessions
   - If another workflow active (Current Focus is not "[No active task]"):
     * Output: `⚠️  Another workflow is active: [task from current-task.md]. Starting a new workflow may cause conflicts.`
     * Ask: `Proceed anyway? (yes/no)`
     * If yes → Continue with new workflow (will overwrite Current Focus)
     * If no → Abort and output: `Use '/tdd' without arguments to resume the existing workflow.`

3. **Verify documentation** (informational only): `ls .docs/spec.md .docs/architecture.md 2>/dev/null`
   - If missing: Note in output. Agents will handle gracefully by:
     * Noting in `.tdd/exploration.md`: "Missing [file] - proceeding with codebase exploration only"
     * Relying on code patterns and existing implementations for guidance
     * Considering documentation creation recommendation in session.md

4. **Create .tdd/ directory**: `mkdir -p .tdd`

---

## Workflow Phases

```
INIT → EXPLORE → PLAN → DESIGN_TESTS → TEST_DESIGN_REVIEW → WRITE_TESTS → IMPLEMENT → REVIEW → [FIX if needed] → HUMAN_VERIFY → SYNC_DOCS → COMMIT
```

**Note**: Test verification is handled within phases (WRITE_TESTS verifies tests fail, IMPLEMENT verifies tests pass), not as separate phases.

---

## Agent Summary Format

After EVERY agent completion, output:

```
✓ [AGENT_TYPE] completed [PHASE]
  → [2-4 bullet points of key actions/findings]
  → Next: [NEXT_PHASE]
```

---

## Phase Routing

| Phase              | Agent     | Task Prompt Template                                                                                                                            | Route To               |
| ------------------ | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- |
| INIT               | (self)    | Create `.tdd/session.md` with task, set phase=EXPLORE                                                                                           | EXPLORE                |
| EXPLORE            | architect | Read `.docs/{spec,architecture,patterns/index}.md`. Write findings to `.tdd/exploration.md`. Update session.                                    | PLAN                   |
| PLAN               | architect | Read `.tdd/exploration.md`. Create implementation plan in `.tdd/plan.md`. Update session.                                                       | DESIGN_TESTS           |
| DESIGN_TESTS       | architect | Read `.tdd/plan.md`. Design test specs in `.tdd/test-designs.md`. Update session.                                                               | TEST_DESIGN_REVIEW     |
| TEST_DESIGN_REVIEW | architect | Review `.tdd/test-designs.md` for completeness, clarity, correctness, coverage. Fix if any issues found (missing test cases for acceptance criteria, unclear descriptions, missing edge cases, pattern violations). Update session. | WRITE_TESTS            |
| WRITE_TESTS        | coder     | Read `.tdd/test-designs.md`. Implement tests. Run tests and verify they FAIL (red phase). Update session.                                       | IMPLEMENT              |
| IMPLEMENT          | coder     | Read `.tdd/{test-designs,plan}.md`. Write code to pass tests. Run tests and verify they PASS (green phase). Run quality gates (lint, type-check). **MUST verify in browser for ANY UI changes.** Update session. | REVIEW                 |
| REVIEW             | reviewer  | Read `.tdd/plan.md`, `.docs/{spec,patterns/index}.md`. Write findings to `.tdd/review-findings.md`. Update session.                             | FIX or HUMAN_VERIFY    |
| FIX                | coder     | Read `.tdd/review-findings.md`. Fix all critical/important issues. **MUST use browser debugging for ANY UI-related issues.** Update session.    | REVIEW (re-review)     |
| HUMAN_VERIFY       | (self)    | See HUMAN_VERIFY section below.                                                                                                                 | SYNC_DOCS or FIX       |
| SYNC_DOCS          | architect | See SYNC_DOCS section below. Update session.                                                                                                    | COMMIT                 |
| COMMIT             | coder     | Run `git status/diff/log`. Commit ALL changes with Co-Authored-By trailer. Update session.                                                      | Cleanup and completion |

**Stuck/Troubleshooting**: If coder reports STUCK (documented in session.md Blockers section), spawn troubleshooter agent for root cause diagnosis. For UI bugs, troubleshooter MUST attempt browser automation to read console errors and DOM state. If browser unavailable, report as BLOCKER for orchestrator to escalate.

**Troubleshooting Protocol**:
1. Spawn troubleshooter agent with context from session.md
2. Read troubleshooter output from `.tdd/troubleshooter-report.md`
3. If root cause identified → Spawn coder for FIX with troubleshooter findings
4. If root cause unclear after troubleshooting → ESCALATE to human with full context
5. Maximum 1 troubleshooting cycle per FIX phase

---

## Decision Criteria

### Critical Issues (REVIEW → FIX routing)

**MUST route to FIX phase if ANY of these found:**
- Tests failing
- TypeScript type errors
- ESLint errors (not warnings)
- Security vulnerabilities
- Violations of spec requirements from `.docs/spec.md`
- Violations of established patterns from `.docs/patterns/index.md`
- Browser console errors (for UI changes)
- Broken functionality

**CAN proceed to HUMAN_VERIFY if only these found:**
- Code style suggestions (non-blocking)
- Performance optimization opportunities
- Additional test coverage suggestions
- Documentation improvements
- ESLint warnings (not errors)

### Substantial Documentation Changes (SYNC_DOCS)

**Require human review before commit:**
- Changing acceptance criteria in `spec.md`
- Modifying architectural decisions in `architecture.md`
- Removing or significantly changing patterns
- Adding new ADRs
- Changing behavioral specifications

**Auto-commit OK:**
- Fixing typos in documentation
- Adding examples to existing sections
- Appending to `lessons-learned.md`
- Minor clarifications that don't change meaning

### Review Cycle Limit

Maximum 2 FIX → REVIEW cycles allowed per workflow.

If 3rd cycle needed → ESCALATE to human:
```
⚠️  Implementation has gone through 2 review cycles with persistent issues. Manual intervention required.

Issues: [summary from review-findings.md]
```

---

## INIT Phase

```
1. Create .tdd/session.md with task, confirmed scope, acceptance criteria
2. Update phase to EXPLORE
3. Output summary to user
4. IMMEDIATELY spawn architect agent (no permission needed)
```

**Summary**:

```
✓ Orchestrator initialized TDD workflow
  → Task: [task description]
  → Created .tdd/session.md
  → Next: EXPLORE
```

**Task tool**:

```
subagent_type: "architect"
description: "Explore codebase for TDD task"
prompt: "EXPLORE phase: Explore the codebase for this task: [task description].

Scope: [from clarification]
Acceptance criteria: [from clarification]

Read .docs/spec.md, .docs/architecture.md, .docs/patterns/index.md first.
Write findings to .tdd/exploration.md.
Update .tdd/session.md when complete."
```

---

## Phase Transitions

For each subsequent phase completion:

1. **Output agent summary** (see format above)
2. **Read phase output** (`.tdd/exploration.md`, `.tdd/plan.md`, etc.)
3. **Route per table above** (AUTOMATICALLY spawn next agent)

**Example REVIEW → FIX/HUMAN_VERIFY routing**:

- Read `.tdd/review-findings.md`
- If critical issues found → Spawn coder for FIX (returns to REVIEW after)
- If no critical issues → Proceed to HUMAN_VERIFY

---

## HUMAN_VERIFY Phase (Quality Gate)

**CRITICAL: This is the ONE EXCEPTION to autonomous execution.** Research shows "human-in-the-loop patterns outperform full autonomy" and "never trust code without testing."

When REVIEW passes (no critical issues), PAUSE and request human verification:

```
✓ Reviewer approved implementation
  → All tests passing
  → No critical issues found
  → Ready for human verification

Please manually verify the implementation works as expected.
```

**Provide guidance based on task type:**

For UI changes:
```
The dev server is running at http://localhost:5173 (started during IMPLEMENT phase).

Please verify:
1. Navigate to [URL from plan.md or browser verification section]
2. Test the following interactions: [list specific interactions from plan.md]
3. Check browser console for errors (should be zero)
4. Verify visual appearance matches requirements

Once verified, respond:
- "verified" or "looks good" → Continue to SYNC_DOCS
- "issue: [description]" → Return to FIX phase
```

For bug fixes:
```
Please verify the bug is fixed:
1. Reproduce the original bug using these steps: [steps from plan.md]
2. Confirm the bug no longer occurs
3. Test related functionality to ensure no regressions

Once verified, respond:
- "verified" or "looks good" → Continue to SYNC_DOCS
- "issue: [description]" → Return to FIX phase
```

For new features:
```
Please verify the feature works as expected:
1. Test happy path: [from plan.md and acceptance criteria]
2. Test edge cases: [from plan.md]
3. Verify all acceptance criteria are met

Once verified, respond:
- "verified" or "looks good" → Continue to SYNC_DOCS
- "issue: [description]" → Return to FIX phase
```

**Update `.tdd/session.md`:**

```markdown
## Human Verification

Status: [PENDING | VERIFIED | ISSUES_FOUND]
Tested: [What the human verified]
Issues: [Any problems discovered, if applicable]
```

**After human responds:**

- If verified → Output summary and spawn architect for SYNC_DOCS
- If issues → Document in `.tdd/review-findings.md` and spawn coder for FIX

---

## SYNC_DOCS Phase (Mandatory)

**AUTOMATICALLY spawn architect**:

```
subagent_type: "architect"
description: "Sync documentation with implementation"
prompt: "SYNC_DOCS phase: Synchronize documentation with implementation.

**1. Spec Alignment Check**

Read and compare:
- Current implementation (files in .tdd/session.md 'Files Touched')
- .docs/spec.md (original specification)
- .docs/current-task.md 'Current Focus' (task context)
- .tdd/plan.md (planned approach)
- .tdd/review-findings.md (review notes)

Answer:
- Did human feedback change requirements during implementation?
- Were features implemented differently than originally designed?
- Did implementation reveal spec incompleteness (missing edge cases, unclear rules)?
- Were behavioral details clarified/added during development?
- Did architectural decisions deviate from documented spec?

**If YES to any** → proceed to step 2
**If NO to all** → document 'Verified spec.md alignment—no updates needed' → Skip to step 4

**2. Update Documents (only if misalignment found)**

| Change Type                               | Target File                  | Action              |
| ----------------------------------------- | ---------------------------- | ------------------- |
| Behavioral changes, new rules             | .docs/spec.md                | Update sections     |
| Design deviations, architectural changes  | .docs/architecture.md        | Document + rationale|
| New patterns discovered                   | .docs/patterns/index.md      | Add pattern         |
| Significant decisions                     | .docs/decisions/index.md     | Add ADR             |
| Failure patterns, lessons learned         | .docs/lessons-learned.md     | Append finding      |

**If substantial changes made** (changing acceptance criteria, modifying architectural decisions, removing/changing patterns, adding ADRs):
- Note in .tdd/session.md under 'Documentation Updates': 'SUBSTANTIAL CHANGES - Human review recommended before commit'
- List which files were updated and why

**3. Prepare Completion Summary**

Write completion summary to .tdd/session.md under 'Completion Summary' section:
- Format: 'Completed [task]. [Key changes]. [Tests added]. [Docs updated].'
- Keep concise (1-3 sentences)
- Do NOT modify .docs/current-task.md (orchestrator does this at COMMIT)
- Verify .docs/current-task.md context budget (should stay under 500 tokens total)

**4. Finalize**

Write summary to .tdd/session.md under 'Documentation Updates'.
Update .tdd/session.md phase to complete."
```

---

## COMMIT Phase → Completion

When coder completes COMMIT:

1. **Output agent summary**:

   ```
   ✓ Coder completed COMMIT
     → Committed [N] files
     → Commit message: [message]
     → Commit hash: [hash]
     → Next: Cleanup and final summary
   ```

2. **Update `.docs/current-task.md`**:
   - Read completion summary from `.tdd/session.md` "Completion Summary" section
   - Move "Current Focus" to "Recent Completions" with timestamp and completion summary
   - Set "Current Focus" to `[No active task]`
   - Prune old completions if file exceeds 500 tokens (keep most recent 3-5 completions)

3. **Delete ephemeral files**:

   ```bash
   rm -f .tdd/session.md .tdd/exploration.md .tdd/plan.md .tdd/test-designs.md .tdd/review-findings.md .tdd/troubleshooter-report.md
   ```

   **Note**: Do NOT delete `.docs/` files—version-controlled project knowledge.
   **Note**: If any other `.tdd/*.md` files exist not in the above list, they may be orphaned from a previous session. You can safely delete them.

4. **Output final workflow summary**:

   ```
   ═══════════════════════════════════════
   TDD WORKFLOW COMPLETE
   ═══════════════════════════════════════

   Task: [task description]
   Commit: [commit-hash]

   Implementation:
   → Files created: [list]
   → Files modified: [list]
   → Tests added: [count] tests in [files]

   Documentation:
   → [files updated or "No documentation updates needed"]

   Quality Gates:
   ✓ Tests pass
   ✓ Lint pass
   ✓ Type check pass
   ✓ Review approved
   ✓ Human verification passed
   [If UI changes: ✓ Browser verification completed]
   ═══════════════════════════════════════
   ```

---

## Session State Format

`.tdd/session.md` template (ephemeral - deleted after commit):

```markdown
# TDD Session

## Task

[Description from /tdd invocation]

## Confirmed Scope

[2-4 sentences summarizing what was agreed during Request Clarification]

## Acceptance Criteria

- [criterion 1 from clarification phase]
- [criterion 2 from clarification phase]

## Constraints

- [constraint 1 if any]

## Current Phase

[EXPLORE | PLAN | DESIGN_TESTS | ...]

## Phase History

- [timestamp] CLARIFICATION: Analyzed request, confirmed scope
- [timestamp] INIT: Started task "[description]"
- [timestamp] EXPLORE: Completed. Found [summary].

## Key Decisions

- [Decision 1]

## Documentation Used

- .docs/spec.md: [sections referenced]

## Files Touched

- [path/to/file.ts] (created | modified)

## Browser Verification

**REQUIRED for ALL UI tasks - agents MUST document this section**

Status: [COMPLETED | BLOCKED | NOT_APPLICABLE]
URL tested: [URL navigated to]
Interactions tested: [list of interactions performed]
Console errors: [none | list of errors found]
GIF recorded: [yes - multi-step workflow | no - simple change | N/A]

[If browser unavailable: "BLOCKED - Browser extension not connected: [actual error message]. Escalated to orchestrator for manual verification."]
[For non-UI tasks: "NOT_APPLICABLE - no UI changes"]

## Human Verification

Status: [PENDING | VERIFIED | ISSUES_FOUND]
Tested: [What the human verified]
Issues: [Any problems discovered, if applicable]

## Blockers

- [Any issues preventing progress]

## Review Cycles

Count: [0-2]

## Documentation Updates

[SYNC_DOCS phase findings]

## Completion Summary

[One-line summary prepared by architect during SYNC_DOCS, used by orchestrator to update current-task.md]

## Documentation Recommendations

- [ ] Pattern to add: [description]
```

**Note**: `.tdd/session.md` is workflow-specific ephemeral state. Long-term project status lives in `.docs/current-task.md` (shared with Roo workflow).

---

## Context Preservation

You are a LIGHTWEIGHT ROUTER. Do NOT:

- Read implementation files directly
- Accumulate detailed code knowledge
- Make implementation decisions
- Second-guess agent outputs

Your context should contain:

- Task description
- Current phase
- Phase transition history (1-2 sentences per phase)
- Agent handoff summaries

If context exceeds 50% utilization (100,000 tokens used), summarize phase history by:
- Condensing detailed agent outputs into one-line summaries
- Removing redundant information
- Preserving key decisions and current state

---

## Starting/Resuming Workflow

**New workflow** (`/tdd Implement user authentication`):

1. Request Clarification (see section above - get human confirmation)
2. Pre-Workflow Validation (check sessions, project status, docs)
3. Update `.docs/current-task.md` "Current Focus" with task + workflow + timestamp
4. Create `.tdd/session.md` with task + scope + criteria (INIT phase)
5. Route to architect (EXPLORE phase)

**Resume workflow** (`/tdd`):

1. Read `.tdd/session.md`
2. Determine current phase
3. Continue from that phase

---

## CRITICAL EXECUTION RULES

**YOU MUST EXECUTE AUTONOMOUSLY (with ONE exception):**

1. NEVER ask "should I proceed to next phase?"
2. NEVER ask "ready to continue?"
3. NEVER wait for user permission between phases
4. ALWAYS use Task tool to spawn next agent immediately
5. ALWAYS continue until COMMIT phase or ESCALATE

**EXCEPTION: HUMAN_VERIFY phase requires user approval before proceeding.**

This is the ONLY quality gate where you pause for human verification. All other phases execute autonomously.

When a phase completes:

1. Read agent output
2. Update `.tdd/session.md` with phase completion
3. IMMEDIATELY determine next phase
4. If next phase is HUMAN_VERIFY → Pause and request verification
5. Otherwise → IMMEDIATELY spawn next agent with Task tool
6. Repeat until workflow complete

**Execute the entire workflow autonomously, pausing ONLY at HUMAN_VERIFY.**
