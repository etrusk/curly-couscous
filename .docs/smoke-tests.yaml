# .docs/smoke-tests.yaml
# Smoke test manifest. Each check must be independently executable (stateless).
# See .docs/smoke-test-instructions.md for execution rules.

version: 1
base_url: "http://localhost:5173"

# === EXECUTION PROTOCOL ===
# See .docs/smoke-test-instructions.md for full agent rules.
# Key constraints: 40K token budget per session, max 5 screenshots per session,
# stateless checks, tiered verification (T1/T2/T3).

# === SCHEMA ===
# Required: id, action, expect
# Optional: tier (T1|T2|T3, default T2), verify_js (JS expression for T2 checks)
# If verify_js is present, tier defaults to T2 unless explicitly overridden.

# === SCRIPT: Victory Path ===
# Tests app load → setup → battle → victory → reset

checks:
  - id: 01-app-loads
    tier: T1
    action: "Navigate to base_url"
    expect: "Hexagonal grid visible within 3 seconds, console has no errors"

  - id: 02-add-friendly
    tier: T2
    action: "Click 'Add Friendly' button, click hex at grid center"
    expect: "Friendly token 'A' appears at center hex"

  - id: 03-add-enemy
    tier: T2
    action: "Add friendly at center, click 'Add Enemy' button, click hex one step above center"
    expect: "Enemy token 'A' appears adjacent to friendly (distance 1)"

  - id: 04-select-friendly
    tier: T2
    action: "Add friendly at center, click friendly token 'A'"
    expect: "Token shows selection border, CharacterPanel header shows 'Friendly A'"

  - id: 05-assign-attack
    tier: T2
    action: "Add friendly at center, select it, in Loadout tab click 'Assign' next to 'Light Punch'"
    expect: "Light Punch appears in Equipped Skills section below Move"

  - id: 06-skill-toggle
    tier: T2
    action: "Add friendly at center, select it, click toggle switch on Move skill in Loadout tab to disable it"
    expect: "Move skill shows disabled state (grayed or unchecked)"

  - id: 07-skill-reorder
    tier: T2
    action: "Add friendly at center, assign Light Punch, in Priority tab click move-up button on Light Punch"
    expect: "Light Punch moves to position 0 (top of list)"

  - id: 08-step-battle
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, click 'Step' button"
    expect: "Tick counter changes from 0 to 1"
    verify_js: "window.__TEST_HARNESS__.getTick() === 1"

  - id: 09-damage-applied
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, click 'Step'"
    expect: "Enemy HP decreased by 10 (Light Punch damage)"
    verify_js: "window.__TEST_HARNESS__.getCharacters().find(c => c.faction === 'enemy').hp === 90"

  - id: 10-continue-to-elimination
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, click 'Step' repeatedly until enemy HP reaches 0"
    expect: "Enemy token removed from grid"
    verify_js: "window.__TEST_HARNESS__.getCharacters().filter(c => c.faction === 'enemy' && c.hp > 0).length === 0"

  - id: 11-victory-state
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, step until enemy eliminated"
    expect: "Badge shows 'Victory', Step/Play buttons disabled"
    verify_js: "window.__TEST_HARNESS__.getBattleStatus() === 'victory'"

  - id: 12-reset
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, step until victory, click 'Reset' button"
    expect: "Characters restored to initial positions with full HP, tick shows 0, badge shows 'Active'"
    verify_js: "window.__TEST_HARNESS__.getTick() === 0 && window.__TEST_HARNESS__.getBattleStatus() === 'active'"

  # === SCRIPT: Defeat Path ===
  # Tests that defeat detection works

  - id: 13-setup-defeat
    tier: T2
    action: "Add enemy at center with Light Punch, add friendly adjacent with no attack skill"
    expect: "Two tokens on grid, only enemy has Light Punch assigned"

  - id: 14-run-to-defeat
    tier: T2
    action: "Add enemy with Light Punch at center, add friendly adjacent with no attack skill, click 'Play' and wait for battle to complete"
    expect: "Badge shows 'Defeat', friendly token eliminated"
    verify_js: "window.__TEST_HARNESS__.getBattleStatus() === 'defeat'"

  - id: 15-final-reset
    tier: T2
    action: "Add enemy with Light Punch at center, add friendly adjacent, run to defeat, click 'Reset' button"
    expect: "Characters restored to initial positions with full HP, tick 0, badge 'Active'"
    verify_js: "window.__TEST_HARNESS__.getTick() === 0 && window.__TEST_HARNESS__.getBattleStatus() === 'active'"

  # === SCRIPT: Two-Panel Layout ===
  # Tests new tabbed interface for CharacterPanel

  - id: 17-panel-tabs
    tier: T3
    action: "Add friendly at center, select friendly character, observe CharacterPanel"
    expect: "Two tabs visible: Loadout and Priority. Loadout tab active by default."

  - id: 18-loadout-tab-content
    tier: T2
    action: "Add friendly at center, select it, observe Loadout tab"
    expect: "Equipped section shows Move skill. Inventory section shows Light Punch, Heavy Punch, Heal."

  - id: 19-priority-tab-content
    tier: T2
    action: "Add friendly at center, select it, click Priority tab"
    expect: "Priority tab shows Move skill row with trigger, target, criterion, behavior dropdowns."

  - id: 20-battle-tab-auto-switch
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, select friendly, click 'Step' button"
    expect: "Panel auto-switches to Priority tab. Skills show evaluation icons."

  - id: 21-evaluation-inline-display
    tier: T3
    action: "Add friendly with Light Punch at center, add enemy adjacent, click 'Step', observe Priority tab"
    expect: "Selected skill shows green checkmark and target. Skipped skills show gray dash."

  # === SCRIPT: AND Combinator UI ===
  # Tests AND trigger add/remove in Priority tab

  - id: 22-and-trigger-add
    tier: T2
    action: "Add friendly at center, select it, assign Light Punch, click Priority tab, click '+ AND' button on Light Punch skill row"
    expect: "Two trigger dropdowns visible with 'AND' label between them. Second dropdown shows default trigger type."

  - id: 23-and-trigger-remove
    tier: T2
    action: "Add friendly at center, select it, assign Light Punch, click Priority tab, click '+ AND' on Light Punch, then click remove button on second trigger"
    expect: "Returns to single trigger dropdown. 'AND' label and second dropdown no longer visible. '+ AND' button reappears."

  # === VERIFICATION ===

  - id: 16-no-console-errors
    tier: T2
    action: "Review browser console for entire script execution"
    expect: "Zero console.error calls, zero uncaught exceptions"
