# .docs/smoke-tests.yaml
# Smoke test manifest. Each check must be independently executable (stateless).
# See .docs/smoke-test-instructions.md for execution rules.

version: 1
base_url: "http://localhost:5173"

# === EXECUTION PROTOCOL ===
# See .docs/smoke-test-instructions.md for full agent rules.
# Key constraints: 40K token budget per session, max 5 screenshots per session,
# stateless checks, tiered verification (T1/T2/T3).

# === SCHEMA ===
# Required: id, action, expect
# Optional: tier (T1|T2|T3, default T2), verify_js (JS expression for T2 checks)
# If verify_js is present, tier defaults to T2 unless explicitly overridden.

# === SCRIPT: Victory Path ===
# Tests app load → setup → battle → victory → reset

checks:
  - id: 01-app-loads
    tier: T1
    action: "Navigate to base_url"
    expect: "Hexagonal grid visible within 3 seconds, console has no errors"

  - id: 02-add-friendly
    tier: T2
    action: "Click 'Add Friendly' button, click hex at grid center"
    expect: "Friendly token 'A' appears at center hex"

  - id: 03-add-enemy
    tier: T2
    action: "Add friendly at center, click 'Add Enemy' button, click hex one step above center"
    expect: "Enemy token 'A' appears adjacent to friendly (distance 1)"

  - id: 04-select-friendly
    tier: T2
    action: "Add friendly at center, click friendly token 'A'"
    expect: "Token shows selection border, CharacterPanel header shows 'Friendly A'"

  - id: 05-assign-attack
    tier: T2
    action: "Add friendly at center, select it, click 'Assign' next to 'Light Punch' in the Inventory section"
    expect: "Light Punch appears in the skill list above Inventory section, below Move"

  - id: 06-skill-toggle
    tier: T2
    action: "Add friendly at center, select it, click the enable checkbox on Move skill to disable it"
    expect: "Move skill shows disabled state (unchecked checkbox)"

  - id: 07-skill-reorder
    tier: T2
    action: "Add friendly at center, assign Light Punch, click move-up button on Light Punch"
    expect: "Light Punch moves to position 0 (top of list)"

  - id: 08-step-battle
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, click 'Step' button"
    expect: "Tick counter changes from 0 to 1"
    verify_js: "window.__TEST_HARNESS__.getTick() === 1"

  - id: 09-damage-applied
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, click 'Step'"
    expect: "Enemy HP decreased by 10 (Light Punch damage)"
    verify_js: "window.__TEST_HARNESS__.getCharacters().find(c => c.faction === 'enemy').hp === 90"

  - id: 10-continue-to-elimination
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, click 'Step' repeatedly until enemy HP reaches 0"
    expect: "Enemy token removed from grid"
    verify_js: "window.__TEST_HARNESS__.getCharacters().filter(c => c.faction === 'enemy' && c.hp > 0).length === 0"

  - id: 11-victory-state
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, step until enemy eliminated"
    expect: "Badge shows 'Victory', Step/Play buttons disabled"
    verify_js: "window.__TEST_HARNESS__.getBattleStatus() === 'victory'"

  - id: 12-reset
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, step until victory, click 'Reset' button"
    expect: "Characters restored to initial positions with full HP, tick shows 0, badge shows 'Active'"
    verify_js: "window.__TEST_HARNESS__.getTick() === 0 && window.__TEST_HARNESS__.getBattleStatus() === 'active'"

  # === SCRIPT: Defeat Path ===
  # Tests that defeat detection works

  - id: 13-setup-defeat
    tier: T2
    action: "Add enemy at center with Light Punch, add friendly adjacent with no attack skill"
    expect: "Two tokens on grid, only enemy has Light Punch assigned"

  - id: 14-run-to-defeat
    tier: T2
    action: "Add enemy with Light Punch at center, add friendly adjacent with no attack skill, click 'Play' and wait for battle to complete"
    expect: "Badge shows 'Defeat', friendly token eliminated"
    verify_js: "window.__TEST_HARNESS__.getBattleStatus() === 'defeat'"

  - id: 15-final-reset
    tier: T2
    action: "Add enemy with Light Punch at center, add friendly adjacent, run to defeat, click 'Reset' button"
    expect: "Characters restored to initial positions with full HP, tick 0, badge 'Active'"
    verify_js: "window.__TEST_HARNESS__.getTick() === 0 && window.__TEST_HARNESS__.getBattleStatus() === 'active'"

  # === SCRIPT: CharacterPanel Layout ===
  # Tests single-view CharacterPanel (no tabs)

  - id: 19-skill-config-content
    tier: T2
    action: "Add friendly at center, select it, observe CharacterPanel"
    expect: "Skill list shows Move skill row with trigger, target, criterion, behavior dropdowns. Inventory section shows Light Punch, Heavy Punch, Heal with Assign buttons."

  - id: 20-battle-mode-display
    tier: T2
    action: "Add friendly with Light Punch at center, add enemy adjacent, select friendly, click 'Step' button"
    expect: "Panel shows battle evaluation. Skills show evaluation icons. No Inventory section visible."

  - id: 21-evaluation-inline-display
    tier: T3
    action: "Add friendly with Light Punch at center, add enemy adjacent, click 'Step', observe CharacterPanel"
    expect: "Selected skill shows green checkmark and target. Skipped skills show gray dash."

  # === SCRIPT: AND Combinator UI ===
  # Tests AND trigger add/remove in Priority tab

  - id: 22-and-trigger-add
    tier: T2
    action: "Add friendly at center, select it, assign Light Punch, click '+ AND' button on Light Punch skill row"
    expect: "Two trigger dropdowns visible with 'AND' label between them. Second dropdown shows default trigger type."

  - id: 23-and-trigger-remove
    tier: T2
    action: "Add friendly at center, select it, assign Light Punch, click '+ AND' on Light Punch, then click remove button on second trigger"
    expect: "Returns to single trigger dropdown. 'AND' label and second dropdown no longer visible. '+ AND' button reappears."

  # === SCRIPT: UI Gap Fixes (NOT toggle, Non-Move duplication) ===

  - id: 24-not-toggle-trigger
    tier: T3
    action: "Add friendly at center, select it, assign Light Punch, change Light Punch trigger from 'Always' to 'HP below', observe NOT toggle button"
    expect: "NOT toggle button appears before the trigger dropdown. Clicking it highlights the button and shows 'NOT' in active state."

  - id: 25-duplicate-non-move-skill
    tier: T3
    action: "Add friendly at center, select it, assign Light Punch, observe skill list"
    expect: "Duplicate button visible next to Light Punch. Clicking it creates a second Light Punch instance in skill list."

  # === SCRIPT: Selector Filter UI ===
  # Tests filter add/configure/remove in Priority tab

  - id: 26-add-selector-filter
    tier: T2
    action: "Add friendly at center, select it, assign Light Punch, click '+ Filter' button on Light Punch skill row"
    expect: "Filter type dropdown ('HP below'/'HP above') and value input (default 50) appear. '+ Filter' button is replaced by filter controls."

  - id: 27-remove-selector-filter
    tier: T2
    action: "Add friendly at center, select it, assign Light Punch, add filter on Light Punch, then click remove filter button (x)"
    expect: "Filter controls disappear. '+ Filter' button reappears. Skill no longer has a filter configured."

  - id: 28-filter-rejection-display
    tier: T3
    action: "Add friendly with Light Punch (hp_below 50% filter) at center, add enemy adjacent at full HP, click 'Step'"
    expect: "Light Punch shows rejected status with filter-related rejection reason text in evaluation display."

  # === SCRIPT: Remove Duplicate & Auto-Focus Toggle ===
  # Tests duplicate skill removal and auto-focus toggle

  - id: 29-remove-duplicate-skill
    tier: T2
    action: "Add friendly at center, select it, assign Light Punch, click 'Duplicate' on Light Punch, then click 'Remove' on one of the Light Punch instances"
    expect: "Only one Light Punch remains in skill list. Remove button no longer visible on remaining instance."

  - id: 30-remove-duplicate-innate
    tier: T2
    action: "Add friendly at center, select it, click 'Duplicate' on Move, then click 'Remove' on one of the Move instances"
    expect: "Only one Move remains in skill list. Remove button no longer visible on remaining Move."

  - id: 31-auto-focus-layout-shift
    tier: T2
    action: "Check 'Auto-focus battle' checkbox. Add friendly with Light Punch at center, add enemy adjacent, click 'Step'"
    expect: "Grid proportions shift to battle layout (wider grid). No tab switch occurs (no tabs). Skills show evaluation icons."

  - id: 32-unassign-skill
    tier: T2
    action: "Add friendly at center, select it, assign Light Punch, click 'Unassign' button on Light Punch"
    expect: "Light Punch removed from skill list and reappears in Inventory section with Assign button"

  # === VERIFICATION ===

  - id: 16-no-console-errors
    tier: T2
    action: "Review browser console for entire script execution"
    expect: "Zero console.error calls, zero uncaught exceptions"
